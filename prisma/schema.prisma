// Prisma schema for Sprint 1

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrgRole {
  owner
  admin
  viewer
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  passwordHash String
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships OrganizationUser[]
  bundleUploads BundleUpload[]
  dashboardLayouts DashboardLayout[]
  activities TeamActivity[]
  refreshTokens RefreshToken[]
  sessions Session[]
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())

  users        OrganizationUser[]
  awsAccounts  AwsAccount[]
  functions    LambdaFunction[]
  bundleUploads BundleUpload[]
  dashboardLayouts DashboardLayout[]
  activities    TeamActivity[]
  notificationChannels NotificationChannel[]
  auditRetentionPolicy AuditRetentionPolicy?
}

model OrganizationUser {
  id     String  @id @default(cuid())
  org    Organization @relation(fields: [orgId], references: [id])
  orgId  String
  user   User @relation(fields: [userId], references: [id])
  userId String
  role   OrgRole

  @@unique([orgId, userId])
}

model AwsAccount {
  id             String        @id @default(cuid())
  org            Organization  @relation(fields: [orgId], references: [id])
  orgId          String
  awsAccountId   String
  roleArn        String
  externalId     String
  defaultRegion  String?
  connectedAt    DateTime?

  functions LambdaFunction[]
}

model LambdaFunction {
  id              String        @id @default(cuid())
  org             Organization  @relation(fields: [orgId], references: [id])
  orgId           String
  awsAccount      AwsAccount    @relation(fields: [awsAccountId], references: [id])
  awsAccountId    String
  region          String
  functionArn     String
  functionName    String
  runtime         String?
  memoryMb        Int?
  timeoutMs       Int?
  lastScannedAt   DateTime?

  coldStartMetrics ColdStartMetrics[]
  bundleUploads    BundleUpload[]
  bundleInsights   BundleInsight[]
  refreshSchedule FunctionRefreshSchedule?
  regionSnapshots RegionMetricsSnapshot[]
  alerts          FunctionAlert[]
  activities      TeamActivity[]

  @@index([orgId])
  @@index([awsAccountId, region])
  @@unique([orgId, functionArn])
}

// Sprint 2: cold start metrics snapshots aggregated per function and time window
model ColdStartMetrics {
  id               String         @id @default(cuid())
  function         LambdaFunction @relation(fields: [functionId], references: [id])
  functionId       String
  periodStart      DateTime
  periodEnd        DateTime
  coldCount        Int            @default(0)
  warmCount        Int            @default(0)
  p50InitMs        Int?
  p90InitMs        Int?
  p99InitMs        Int?
  source           String         @default("logs_insights")
  createdAt        DateTime       @default(now())

  @@index([functionId, periodStart])
}

enum BundleUploadStatus {
  pending
  processing
  completed
  failed
}

model BundleUpload {
  id               String              @id @default(cuid())
  org              Organization        @relation(fields: [orgId], references: [id])
  orgId            String
  function         LambdaFunction      @relation(fields: [functionId], references: [id])
  functionId       String
  uploadedBy       User?               @relation(fields: [uploadedByUserId], references: [id])
  uploadedByUserId String?
  originalFilename String
  storageBucket    String
  storageKey       String
  sizeBytes        Int
  status           BundleUploadStatus  @default(pending)
  errorMessage     String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  processedAt      DateTime?

  insight BundleInsight?

  @@index([orgId])
  @@index([functionId])
}

model BundleInsight {
  id                  String         @id @default(cuid())
  upload              BundleUpload   @relation(fields: [uploadId], references: [id])
  uploadId            String         @unique
  function            LambdaFunction @relation(fields: [functionId], references: [id])
  functionId          String
  totalSizeBytes      Int
  uncompressedBytes   Int?
  fileCount           Int?
  dependencyCount     Int?
  score               Int
  topDependencies     Json?
  sizeBreakdown       Json?
  recommendations     Json?
  createdAt           DateTime       @default(now())

  @@index([functionId])
}


model FunctionRefreshSchedule {
  id        String         @id @default(cuid())
  function  LambdaFunction @relation(fields: [functionId], references: [id])
  functionId String        @unique
  cron      String         @default("0 3 * * *")
  timezone  String         @default("UTC")
  enabled   Boolean        @default(true)
  range     String         @default("7d")
  regions   Json?
  lastRunAt DateTime?
  lastRunStatus String?
  lastRunError String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}


model RegionMetricsSnapshot {
  id          String         @id @default(cuid())
  function    LambdaFunction @relation(fields: [functionId], references: [id])
  functionId  String
  region      String
  periodStart DateTime
  periodEnd   DateTime
  coldCount   Int            @default(0)
  warmCount   Int            @default(0)
  p50InitMs   Int?
  p90InitMs   Int?
  p99InitMs   Int?
  createdAt   DateTime       @default(now())

  @@index([functionId, region, periodStart])
}

model FunctionAlert {
  id            String         @id @default(cuid())
  function      LambdaFunction @relation(fields: [functionId], references: [id])
  functionId    String
  region        String
  metric        String
  severity      String         @default("warning")
  message       String
  status        String         @default("open")
  observedValue Int?
  threshold     Int?
  createdAt     DateTime       @default(now())
  resolvedAt    DateTime?

  @@index([functionId, status])
}

model DashboardLayout {
  id          String        @id @default(cuid())
  org         Organization  @relation(fields: [orgId], references: [id])
  orgId       String
  name        String
  description String?
  config      Json
  createdBy   User?         @relation(fields: [createdById], references: [id])
  createdById String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([orgId])
}

model TeamActivity {
  id          String        @id @default(cuid())
  org         Organization  @relation(fields: [orgId], references: [id])
  orgId       String
  function    LambdaFunction? @relation(fields: [functionId], references: [id])
  functionId  String?
  user        User?         @relation(fields: [userId], references: [id])
  userId      String?
  type        String
  message     String
  payload     Json?
  createdAt   DateTime      @default(now())

  @@index([orgId, createdAt])
}

model NotificationChannel {
  id          String        @id @default(cuid())
  org         Organization  @relation(fields: [orgId], references: [id])
  orgId       String
  type        String
  target      String
  description String?
  enabled     Boolean       @default(true)
  config      Json?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([orgId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())
  session   Session?

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Session {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  refreshTokenId String? @unique
  refreshToken RefreshToken? @relation(fields: [refreshTokenId], references: [id], onDelete: Cascade)
  device      String?
  ipAddress   String?
  userAgent   String?
  lastActivityAt DateTime @default(now())
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([lastActivityAt])
}

model AuditLog {
  id            String   @id @default(cuid())
  userId        String?
  orgId         String?
  action        String
  resourceType  String?
  resourceId    String?
  ipAddress     String?
  userAgent     String?
  requestMethod String?
  requestPath   String?
  requestBody   Json?
  responseStatus Int?
  metadata      Json?
  createdAt     DateTime @default(now())

  @@index([userId, createdAt])
  @@index([orgId, createdAt])
  @@index([action, createdAt])
  @@index([resourceType, resourceId])
}

model AuditRetentionPolicy {
  id            String   @id @default(cuid())
  orgId         String   @unique
  org           Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  retentionDays Int      @default(90)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SecretRotation {
  id          String   @id @default(cuid())
  secretName  String
  rotatedAt   DateTime @default(now())
  rotatedBy   String?
  status      String   // 'success' | 'failed'
  errorMessage String?

  @@index([secretName, rotatedAt])
  @@index([rotatedBy])
}
